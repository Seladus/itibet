<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="/styles/style.css" rel="stylesheet" />
    <title>ITI BET</title>
  </head>

  <body class="bg-gray-700">
    <div class="h-screen w-screen">
      <div class="bg-gray-600 pt-5 px-4 sm:pt-6 sm:px-6 shadow">
        <div class="flex justify-between">
          <div>
            <div class="absolute bg-primary-400 rounded-md p-3">
              <!-- Heroicon name: outline/users -->
              <svg
                class="h-6 w-6 text-white"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
            </div>
            <p class="ml-16 text-sm font-medium text-gray-300 truncate">
              Coins
            </p>
            <div class="ml-16 pb-4 flex items-baseline sm:pb-7">
              <p id="coins" class="text-2xl font-semibold text-gray-100">
                71,897
              </p>
            </div>
            <!-- <p
            class="
              ml-2
              flex
              items-baseline
              text-sm
              font-semibold
              text-green-600
            "
          >
            <svg
              class="self-center flex-shrink-0 h-5 w-5 text-green-500"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 20 20"
              fill="currentColor"
              aria-hidden="true"
            >
              <path
                fill-rule="evenodd"
                d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z"
                clip-rule="evenodd"
              />
            </svg>
            <span class="sr-only"> Increased by </span>
            122
          </p> -->
          </div>
          <div class="grid justify-items-end">
            <p class="text-sm font-medium text-white">
              Name: <span id="name"></span>
            </p>
            <!-- <p
              class="text-base text-gray-300 hover:text-gray-400"
              onclick="copyRoomLinkToClipboard()"
            >
              Copy Room Link
            </p> -->
          </div>
        </div>
      </div>
      <div class="p-4">
        <ul role="list">
          <p id="room-link" class="text-gray-300 text-xs"></p>
          <h2 class="block text-sm font-medium text-white">Leaderboard</h2>

          <li class="py-1 flex">
            <svg
              class="h-10 w-10 text-gold"
              aria-hidden="true"
              focusable="false"
              data-prefix="fas"
              data-icon="medal"
              class="svg-inline--fa fa-medal fa-w-16"
              role="img"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 512 512"
            >
              <path
                fill="currentColor"
                d="M223.75 130.75L154.62 15.54A31.997 31.997 0 0 0 127.18 0H16.03C3.08 0-4.5 14.57 2.92 25.18l111.27 158.96c29.72-27.77 67.52-46.83 109.56-53.39zM495.97 0H384.82c-11.24 0-21.66 5.9-27.44 15.54l-69.13 115.21c42.04 6.56 79.84 25.62 109.56 53.38L509.08 25.18C516.5 14.57 508.92 0 495.97 0zM256 160c-97.2 0-176 78.8-176 176s78.8 176 176 176 176-78.8 176-176-78.8-176-176-176zm92.52 157.26l-37.93 36.96 8.97 52.22c1.6 9.36-8.26 16.51-16.65 12.09L256 393.88l-46.9 24.65c-8.4 4.45-18.25-2.74-16.65-12.09l8.97-52.22-37.93-36.96c-6.82-6.64-3.05-18.23 6.35-19.59l52.43-7.64 23.43-47.52c2.11-4.28 6.19-6.39 10.28-6.39 4.11 0 8.22 2.14 10.33 6.39l23.43 47.52 52.43 7.64c9.4 1.36 13.17 12.95 6.35 19.59z"
              ></path>
            </svg>
            <div class="ml-3">
              <p id="top1-name" class="text-sm font-medium text-white"></p>
              <p id="top1-coins" class="text-sm font-medium text-green-400"></p>
            </div>
          </li>

          <li class="py-1 flex">
            <svg
              class="h-10 w-10 text-silver"
              aria-hidden="true"
              focusable="false"
              data-prefix="fas"
              data-icon="medal"
              class="svg-inline--fa fa-medal fa-w-16"
              role="img"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 512 512"
            >
              <path
                fill="currentColor"
                d="M223.75 130.75L154.62 15.54A31.997 31.997 0 0 0 127.18 0H16.03C3.08 0-4.5 14.57 2.92 25.18l111.27 158.96c29.72-27.77 67.52-46.83 109.56-53.39zM495.97 0H384.82c-11.24 0-21.66 5.9-27.44 15.54l-69.13 115.21c42.04 6.56 79.84 25.62 109.56 53.38L509.08 25.18C516.5 14.57 508.92 0 495.97 0zM256 160c-97.2 0-176 78.8-176 176s78.8 176 176 176 176-78.8 176-176-78.8-176-176-176zm92.52 157.26l-37.93 36.96 8.97 52.22c1.6 9.36-8.26 16.51-16.65 12.09L256 393.88l-46.9 24.65c-8.4 4.45-18.25-2.74-16.65-12.09l8.97-52.22-37.93-36.96c-6.82-6.64-3.05-18.23 6.35-19.59l52.43-7.64 23.43-47.52c2.11-4.28 6.19-6.39 10.28-6.39 4.11 0 8.22 2.14 10.33 6.39l23.43 47.52 52.43 7.64c9.4 1.36 13.17 12.95 6.35 19.59z"
              ></path>
            </svg>
            <div class="ml-3">
              <p id="top2-name" class="text-sm font-medium text-white"></p>
              <p id="top2-coins" class="text-sm font-medium text-green-400"></p>
            </div>
          </li>

          <li class="py-1 flex">
            <svg
              class="h-10 w-10 text-bronze"
              aria-hidden="true"
              focusable="false"
              data-prefix="fas"
              data-icon="medal"
              class="svg-inline--fa fa-medal fa-w-16"
              role="img"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 512 512"
            >
              <path
                fill="currentColor"
                d="M223.75 130.75L154.62 15.54A31.997 31.997 0 0 0 127.18 0H16.03C3.08 0-4.5 14.57 2.92 25.18l111.27 158.96c29.72-27.77 67.52-46.83 109.56-53.39zM495.97 0H384.82c-11.24 0-21.66 5.9-27.44 15.54l-69.13 115.21c42.04 6.56 79.84 25.62 109.56 53.38L509.08 25.18C516.5 14.57 508.92 0 495.97 0zM256 160c-97.2 0-176 78.8-176 176s78.8 176 176 176 176-78.8 176-176-78.8-176-176-176zm92.52 157.26l-37.93 36.96 8.97 52.22c1.6 9.36-8.26 16.51-16.65 12.09L256 393.88l-46.9 24.65c-8.4 4.45-18.25-2.74-16.65-12.09l8.97-52.22-37.93-36.96c-6.82-6.64-3.05-18.23 6.35-19.59l52.43-7.64 23.43-47.52c2.11-4.28 6.19-6.39 10.28-6.39 4.11 0 8.22 2.14 10.33 6.39l23.43 47.52 52.43 7.64c9.4 1.36 13.17 12.95 6.35 19.59z"
              ></path>
            </svg>
            <div class="ml-3">
              <p id="top3-name" class="text-sm font-medium text-white"></p>
              <p id="top3-coins" class="text-sm font-medium text-green-400"></p>
            </div>
          </li>
        </ul>

        <div class="max-w-7xl mx-auto py-16 px-4 sm:py-24 sm:px-6 lg:px-8">
          <div class="text-center">
            <p
              id="state-description"
              class="mt-1 text-2xl font-extrabold text-white"
            >
              Waiting for the admin to start the game...
            </p>
          </div>
        </div>

        <div id="admin" class="mb-2 hidden">
          <h2 class="block text-sm font-medium text-white">Admin</h2>

          <div class="justify-center space-y-2">
            <button
              id="next-phase"
              class="
                group
                relative
                w-full
                flex
                justify-center
                py-2
                px-4
                border border-transparent
                text-sm
                font-medium
                rounded-md
                text-white
                bg-primary-400
                hover:bg-primary-500
                focus:outline-none
                focus:ring-2
                focus:ring-offset-2
                focus:ring-primary-300
              "
              onclick="toggleNextPhase()"
            >
              Open Bets
            </button>
            <div id="cashout" class="hidden grid-cols-3 gap-3 mt-5">
              <button
                class="
                  mt-3
                  w-full
                  inline-flex
                  justify-center
                  rounded-md
                  border border-transparent
                  shadow-sm
                  px-4
                  py-2
                  bg-red-400
                  text-base
                  font-medium
                  text-white
                  hover:bg-red-500
                  focus:outline-none
                  focus:ring-2
                  focus:ring-offset-2
                  focus:ring-red-300
                  sm:text-sm
                "
                onclick="handleCloseBetsButton('red')"
              >
                Red Team
              </button>
              <button
                type="button"
                class="
                  mt-3
                  w-full
                  inline-flex
                  justify-center
                  rounded-md
                  border border-transparent
                  shadow-sm
                  px-4
                  py-2
                  text-white
                  bg-gray-500
                  hover:bg-gray-50
                  focus:outline-none
                  focus:ring-2
                  focus:ring-offset-2
                  focus:ring-primary-300
                "
                onclick="handleCloseBetsButton('neutral')"
              >
                Draw
              </button>
              <button
                class="
                  mt-3
                  w-full
                  inline-flex
                  justify-center
                  rounded-md
                  border border-transparent
                  shadow-sm
                  px-4
                  py-2
                  bg-blue-400
                  text-base
                  font-medium
                  text-white
                  hover:bg-blue-500
                  focus:outline-none
                  focus:ring-2
                  focus:ring-offset-2
                  focus:ring-blue-300
                  sm:text-sm
                "
                onclick="handleCloseBetsButton('blue')"
              >
                Blue Team
              </button>
            </div>
          </div>
        </div>

        <div>
          <label for="price" class="block text-sm font-medium text-white"
            >Bet</label
          >
          <div class="mt-1 relative rounded-md shadow-sm">
            <div
              class="
                absolute
                inset-y-0
                left-0
                pl-3
                flex
                items-center
                pointer-events-none
              "
            >
              <span class="text-gray-500 sm:text-sm"> $ </span>
            </div>
            <input
              type="number"
              name="bet"
              id="bet"
              class="
                focus:ring-primary-300 focus:border-primary-300
                block
                w-full
                pl-7
                pr-12
                sm:text-sm
                border-gray-300
                rounded-md
              "
              placeholder="0"
              aria-describedby="price-currency"
            />
            <div
              class="
                absolute
                inset-y-0
                right-0
                pr-3
                flex
                items-center
                pointer-events-none
              "
            >
              <span class="text-gray-500 sm:text-sm" id="price-currency">
                BTC
              </span>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3 mt-5">
          <button
            class="
              mt-3
              w-full
              inline-flex
              justify-center
              rounded-md
              border border-transparent
              shadow-sm
              px-4
              py-2
              bg-red-400
              text-base
              font-medium
              text-white
              hover:bg-red-500
              focus:outline-none
              focus:ring-2
              focus:ring-offset-2
              focus:ring-red-300
              sm:text-sm
            "
            onclick="placeBet(roomInfos.roomId, roomInfos.player.playerId, document.getElementById('bet').value, 'red')"
          >
            Red Team
          </button>
          <button
            class="
              mt-3
              w-full
              inline-flex
              justify-center
              rounded-md
              border border-transparent
              shadow-sm
              px-4
              py-2
              bg-blue-400
              text-base
              font-medium
              text-white
              hover:bg-blue-500
              focus:outline-none
              focus:ring-2
              focus:ring-offset-2
              focus:ring-blue-300
              sm:text-sm
            "
            onclick="placeBet(roomInfos.roomId, roomInfos.player.playerId, document.getElementById('bet').value, 'blue')"
          >
            Blue Team
          </button>
        </div>
      </div>
    </div>
  </body>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    async function copyRoomLinkToClipboard() {
      const invitationLink = `${window.location.origin}/identification?roomId=${roomInfos.roomId}`;
      await navigator.clipboard.writeText(invitationLink);
    }

    var room = {};
    var team = "neutral";

    function changeTeam(newTeam, state) {
      if (state === 0) {
        console.log(`Changing team... New team is ${newTeam}.`);
        team = newTeam;
      }
    }

    function checkRoom(roomId) {
      fetch(`/room/${roomId}`, {
        method: "GET",
      })
        .then((response) => {
          if (response.status != 200) {
            console.log("Can't join the room.");
            window.location.href = "/";
            window.location.replace("/");
          }

          response.json().then((data) => {
            console.log(data);
          });
        })
        .catch((error) => {
          console.log(error);
        });
    }

    function startBettingPhase(roomId, userId) {
      fetch(`/room/${roomId}/bet/betting/start?userid=${userId}`, {
        method: "POST",
      })
        .then((response) => {
          if (response.status != 200) {
            console.log("Can't start betting phase");
          }
          console.log("Betting phase started.");
        })
        .catch((error) => {
          console.log(error);
        });
    }

    function endBettingPhase(roomId, userId) {
      fetch(`/room/${roomId}/bet/betting/end?userid=${userId}`, {
        method: "POST",
      })
        .then((response) => {
          if (response.status != 200) {
            console.log("Can't end betting phase");
          }
          console.log("Betting phase ended.");
        })
        .catch((error) => {
          console.log(error);
        });
    }

    function closeBet(roomId, userId, team) {
      fetch(`/room/${roomId}/bet/close?userid=${userId}&team=${team}`, {
        method: "POST",
      })
        .then((response) => {
          if (response.status != 200) {
            console.log("Can't close bet");
          } else {
            console.log("Bet successfully closed.");
          }
        })
        .catch((error) => {
          console.log(error);
        });
    }

    function placeBet(roomId, userId, value, team) {
      if (team != "neutral") {
        fetch(
          `/room/${roomId}/bet/place?userid=${userId}&bet=${value}&team=${team}`,
          {
            method: "PUT",
          }
        )
          .then((response) => {
            if (response.status != 200) {
              console.log("Could not place the bet.");
            } else {
              console.log("Bet placed.");
              localStorage.setItem(
                "lastBet",
                JSON.stringify({
                  roomId: roomId,
                  value: value,
                  team: team,
                })
              );
            }
          })
          .catch((error) => {
            console.log(error);
          });
      }
    }

    function updateCoinsAmount(value) {
      let element = document.getElementById("coins");
      element.textContent = value;
    }

    function updateLeaderBoard(leaderboard) {
      console.log(leaderboard);
      for (let i = 0; i < 3; i++) {
        const field_name = `top${i + 1}-name`;
        const field_coins = `top${i + 1}-coins`;

        if (leaderboard[i]) {
          document.getElementById(field_name).textContent = leaderboard[i].name;
          document.getElementById(field_coins).textContent =
            leaderboard[i].coins;
        }
      }
    }

    function handleCloseBetsButton(team) {
      const nextPhaseButton = document.getElementById("next-phase");
      const cashoutButtons = document.getElementById("cashout");
      nextPhaseButton.style.display = "flex";
      nextPhaseButton.textContent = "Open Bets";
      cashoutButtons.style.display = "none";
      closeBet(roomInfos.roomId, roomInfos.player.playerId, team);
    }

    function updateStateDescription(state) {
      let element = document.getElementById("state-description");
      let text = "";
      if (state === 0) {
        const lastBet = JSON.parse(localStorage.getItem("lastBet"));
        if (lastBet !== null) {
          text = `Bet placed !\n
          <div><span class="${
            lastBet.team === "red" ? "text-red-400" : "text-blue-400"
          }">${lastBet.value}</span></div>`;
        } else {
          text = "Place your bets";
        }
      } else if (state === 1) {
        if (localStorage.getItem("lastBet") !== null) {
          text = `Bets are closed\n<div class="">
            <span class="text-red-400">${roomInfos.internalState.ratingRed}</span> : 
            <span class="text-blue-400">${roomInfos.internalState.ratingBlue}</span></div>`;
        } else {
          text = `Bets are closed\n<div class="">
            <span class="text-red-400">${roomInfos.internalState.ratingRed}</span> : 
            <span class="text-blue-400">${roomInfos.internalState.ratingBlue}</span></div>`;
        }
      } else if (state === 2) {
        localStorage.removeItem("lastBet");
        text = "Waiting for the admin to start the game...";
      }
      element.innerHTML = text;
    }

    function updateName(name) {
      let element = document.getElementById("name");
      element.textContent = name;
    }

    function updateButtonState(state) {
      const nextPhaseButton = document.getElementById("next-phase");
      const cashoutButtons = document.getElementById("cashout");

      switch (state) {
        case 0: {
          nextPhaseButton.textContent = "Close Bets";
          break;
        }
        case 1: {
          nextPhaseButton.style.display = "none";
          cashoutButtons.style.display = "grid";
          break;
        }
        case 2: {
          break;
        }
      }

      const betButton = document.getElementById("bet");
      switch (state) {
        case 0: {
          betButton.disabled = false;
          break;
        }
        default: {
          betButton.disabled = true;
        }
      }
    }

    function getUpdatedRoomState(roomId) {
      fetch(`/room/${roomId}`, {
        method: "GET",
      })
        .then((response) => {
          if (response.status != 200) {
            console.log("Can't get room state.");
          }

          response.json().then((data) => {
            console.log(data);
            roomInfos.internalState = data;
            updateButtonState(roomInfos.internalState.state);
            updateCoinsAmount(
              roomInfos.internalState.players[roomInfos.player.id].coins
            );
            updateLeaderBoard(roomInfos.internalState.leaderBoard);
            updateStateDescription(roomInfos.internalState.state);
            updateName(
              roomInfos.internalState.players[roomInfos.player.id].name
            );
            console.log("Room state updated.");
          });
        })
        .catch((error) => {
          console.log(error);
        });
    }

    function toggleNextPhase() {
      const nextPhaseButton = document.getElementById("next-phase");
      const cashoutButtons = document.getElementById("cashout");
      switch (roomInfos.internalState.state) {
        case 2: {
          startBettingPhase(roomInfos.roomId, roomInfos.player.playerId);
          nextPhaseButton.textContent = "Close Bets";
          break;
        }
        case 0: {
          endBettingPhase(roomInfos.roomId, roomInfos.player.playerId);
          nextPhaseButton.style.display = "none";
          cashoutButtons.style.display = "grid";
          break;
        }
      }
    }

    roomInfos = JSON.parse(localStorage.getItem("roomInfo"));
    roomInfos = roomInfos == null ? {} : roomInfos;

    if (
      roomInfos != null &&
      !("roomId" in roomInfos && "player" in roomInfos)
    ) {
      console.log("OUIOUI");
      window.location.href = "/";
      window.location.replace("/");
    } else {
      document.getElementById(
        "room-link"
      ).textContent = `${window.location.origin}/identification?roomId=${roomInfos.roomId}`;

      if (roomInfos.player.isOwner) {
        ownerpanel = document.getElementById("admin");
        ownerpanel.style.display = "block";
      }

      checkRoom(roomInfos.roomId);
      getUpdatedRoomState(roomInfos.roomId);

      var socket = io();
      socket.on("update", (_) => {
        console.log("UPDATE REQUIRED");
        getUpdatedRoomState(roomInfos.roomId);
      });
      socket.emit("join", { roomId: roomInfos.roomId });
    }
  </script>
</html>
